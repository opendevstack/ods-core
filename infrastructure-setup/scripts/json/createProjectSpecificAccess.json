{
  "name":"createProjectAccess",
  "content":"import org.sonatype.nexus.selector.*;
   import org.sonatype.nexus.common.entity.*;
   import org.sonatype.nexus.security.*;
   import org.sonatype.nexus.security.authz.*;
   import com.google.common.collect.ImmutableMap;
   def securitySystem = container.lookup(SecuritySystem.class.name);
   def authorizationManager = securitySystem.getAuthorizationManager('default');   
   def projectName = args.toString().toLowerCase();
   def userName = \"ods-$projectName-nx-user\";
   def password = UUID.randomUUID().toString();
   def infoMail = \"$userName@opendevstack.org\";
   def selectorExpression = \"path =~ \\\".*/$projectName/.*\\\"\";
   def selectorManager = container.lookup(SelectorManager.class.name);
   def selectorConfig = new SelectorConfiguration(name: \"ods-$projectName-selector\",type: 'CSEL',description: \"Content selector for project $projectName\",attributes: ['expression': selectorExpression]);
   if (selectorManager.browse().find { it -> it.name == selectorConfig.name } == null) { selectorManager.create(selectorConfig) };
   def repos = ['candidates', 'releases'];
   def privileges = [];
   for(repo in repos) {;
   def repoProperties = ImmutableMap.builder().put('content-selector', selectorConfig.name).put('repository', repo).put('actions', 'browse,read,edit').build();
   def repoPrivilege = new org.sonatype.nexus.security.privilege.Privilege(id: \"ods-$projectName-$repo-priv\",version: '',name: \"ods-$projectName-$repo-priv\",description: \"Content Selector $projectName $repo privilege\",type: 'repository-content-selector',properties: repoProperties);
   authorizationManager.addPrivilege(repoPrivilege);
   privileges.add(repoPrivilege.id)
   };
   def role = new org.sonatype.nexus.security.role.Role(roleId: \"ods-$projectName-access-role\",source: 'Nexus',name: \"ods-$projectName-access-role\",description: \"Role for $projectName\",readOnly: false,privileges: privileges,roles: ['opendevstack-developer']);
   authorizationManager.addRole(role);
   security.addUser(userName,projectName,'User',infoMail, true,password, [ role.roleId ]);
   return groovy.json.JsonOutput.toJson([user: userName, passb64: password.bytes.encodeBase64().toString()])",
   "type":"groovy"
}
