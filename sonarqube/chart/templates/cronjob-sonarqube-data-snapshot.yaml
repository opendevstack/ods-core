apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.global.appName }}-volume-snapshot
  labels:
    app: {{ .Values.global.appName }}
spec:
  schedule: "{{ .Values.global.backupSchedule }}"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 3600
  suspend: false
  jobTemplate:
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 604800
      template:
        spec:
          serviceAccountName: ods-edit
          containers:
          - name: snapshot-creator
            image: image-registry.openshift-image-registry.svc:5000/openshift/ose-cli:latest
            command:
            - /bin/sh
            - -c
            - |
              # compute snapshot name so we can check it later
              SNAP_NAME="{{ .Values.global.appName }}-snapshot.$(date +%Y-%m-%d.%H-%M-%S)"
              cat <<EOF | oc apply -f -
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: $SNAP_NAME
                namespace: {{ .Values.global.odsNamespace }}
              spec:
                volumeSnapshotClassName: {{ .Values.global.sonarqubeFastStorageClassBackup }}
                source:
                  persistentVolumeClaimName: {{ .Values.global.sonarqubeDataStorageName }}
              EOF
            resources:
              limits:
                cpu: '1'
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            imagePullPolicy: IfNotPresent
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
  successfulJobsHistoryLimit: 30
  failedJobsHistoryLimit: 30